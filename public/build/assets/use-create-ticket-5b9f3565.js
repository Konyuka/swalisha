import{cW as z,cX as O,cY as H,cZ as V,c_ as U,O as Y,ak as A,v as k,r as o,bj as Z,j as s,s as P,a5 as D,t as R,c as b,B as N,T as d,y as G,F as W,G as X,b3 as J,aZ as ee,c$ as Q,Q as te,au as se,u as ae,D as re,f as ie,ae as ne,N as ce,z as oe,E as ue,al as B,aH as $,a3 as de,g as le,av as fe,aw as me,aF as he,a7 as xe,a6 as L,a4 as ge,m as pe}from"./main-0be1d019.js";import{k as je,y as ye,C as ve}from"./reply-editor-b3f60ce1.js";var be=class extends z{constructor(e,t){super(e,t)}bindMethods(){super.bindMethods(),this.fetchNextPage=this.fetchNextPage.bind(this),this.fetchPreviousPage=this.fetchPreviousPage.bind(this)}setOptions(e,t){super.setOptions({...e,behavior:O()},t)}getOptimisticResult(e){return e.behavior=O(),super.getOptimisticResult(e)}fetchNextPage(e){return this.fetch({...e,meta:{fetchMore:{direction:"forward"}}})}fetchPreviousPage(e){return this.fetch({...e,meta:{fetchMore:{direction:"backward"}}})}createResult(e,t){var p,m,h,l;const{state:a}=e,r=super.createResult(e,t),{isFetching:i,isRefetching:n}=r,u=i&&((m=(p=a.fetchMeta)==null?void 0:p.fetchMore)==null?void 0:m.direction)==="forward",c=i&&((l=(h=a.fetchMeta)==null?void 0:h.fetchMore)==null?void 0:l.direction)==="backward";return{...r,fetchNextPage:this.fetchNextPage,fetchPreviousPage:this.fetchPreviousPage,hasNextPage:H(t,a.data),hasPreviousPage:V(t,a.data),isFetchingNextPage:u,isFetchingPreviousPage:c,isRefetching:n&&!u&&!c}}};function ke(e,t){return U(e,be,t)}function Ue(e){return Y({queryKey:["tickets",e],queryFn:()=>De(e),placeholderData:A})}function De(e){return k.get("tickets",{params:e}).then(t=>t.data)}function Se({user:e,...t}){var r;const{auth:a}=o.useContext(Z);return s.jsx(je,{...t,label:e==null?void 0:e.display_name,src:e==null?void 0:e.avatar,link:(e==null?void 0:e.id)&&((r=a.getUserProfileLink)==null?void 0:r.call(a,e))})}function Ye(){return P({mutationFn:e=>we(e),onSuccess:async()=>{D.invalidateQueries({queryKey:["mailbox","sidenav-tags"]}),await D.invalidateQueries({queryKey:["tickets"]})},onError:e=>R(e)})}function we(e){return k.post("tickets/status/change",e).then(t=>t.data)}function Ze({query:{isInitialLoading:e,fetchNextPage:t,isFetchingNextPage:a,hasNextPage:r},children:i,loaderMarginTop:n="mt-24",style:u,className:c,variant:p="infiniteScroll",loadMoreExtraContent:m,size:h="md"}){const l=o.useRef(null),j=a||e,[x,C]=o.useState(0),f=p==="loadMore"&&x<3?"loadMore":"infiniteScroll";o.useEffect(()=>{const y=l.current;if(!y||f==="loadMore")return;const S=new IntersectionObserver(([w])=>{w.isIntersecting&&r&&!j&&t()});return S.observe(y),()=>{S.unobserve(y)}},[t,r,j,f]);let v;return i?v=a?i:null:f==="loadMore"?v=!e&&r&&s.jsxs("div",{className:b("flex items-center gap-8",n),children:[m,s.jsx(N,{size:h==="md"?"sm":"xs",className:b(h==="sm"?"min-h-24 min-w-96":"min-h-36 min-w-112"),variant:"outline",color:"primary",onClick:()=>{t(),C(x+1)},disabled:j,children:x>=2&&!a?s.jsx(d,{message:"Load all"}):s.jsx(d,{message:"Show more"})})]}):v=s.jsx(G,{children:a&&s.jsx(W.div,{className:b("flex justify-center w-full",n),...X,children:s.jsx(J,{size:h,isIndeterminate:!0,"aria-label":"loading"})})}),s.jsxs("div",{style:u,className:b("w-full",c,r&&"min-h-36"),role:"presentation",children:[s.jsx("div",{ref:l,"aria-hidden":!0}),v]})}const _={isDirty:!1,isSaving:!1,body:void 0,attachments:[]},K=ee()(e=>({editorIsOpen:!1,setEditorIsOpen:t=>e(a=>({editorIsOpen:t})),ticketIsSaving:!1,setTicketIsSaving:t=>e(a=>({ticketIsSaving:t})),activeDraft:_,updateActiveDraft:t=>e(a=>{var i;const r=!Pe(t.body)||!!((i=t.attachments)!=null&&i.length);return{activeDraft:{...a.activeDraft,isDirty:r,...t}}}),discardActiveDraft:()=>e(()=>({activeDraft:_}))}));function q(){return K.getState()}function Pe(e){return e?e.trim()==="<p></p>"||!e.trim():!0}function Ne({queryKey:e,defaultOrderDir:t,defaultOrderBy:a,queryParams:r},i,n=""){return i.orderBy||(i.orderBy=a),i.orderDir||(i.orderDir=t),[...e,i,n,r]}function Ce(e){var w,E,I,M;const{initialPage:t,endpoint:a,defaultOrderBy:r,defaultOrderDir:i,queryParams:n,paginate:u,transformResponse:c,willSortOrFilter:p=!1}=e,[m,h]=o.useState(""),[l,j]=o.useState({orderBy:r,orderDir:i}),x=Ne(e,l,m),C=o.useRef(Q(x)).current,f=ke({placeholderData:p?A:void 0,queryKey:x,queryFn:({pageParam:g,signal:T})=>{const F={...n,perPage:(t==null?void 0:t.per_page)||(n==null?void 0:n.perPage),query:(n==null?void 0:n.query)??m,paginate:u,...l};return u==="cursor"?F.cursor=g:F.page=g||1,Te(a,F,c,T)},initialPageParam:u==="cursor"?"":1,getNextPageParam:g=>ye(g.pagination)?"next_cursor"in g.pagination?g.pagination.next_cursor:g.pagination.current_page+1:null,initialData:()=>{if(!(!t||Q(x)!==C))return{pageParams:[void 0,1],pages:[{pagination:t}]}}}),v=o.useMemo(()=>{var g;return((g=f.data)==null?void 0:g.pages.flatMap(T=>T.pagination.data))||[]},[(w=f.data)==null?void 0:w.pages]),y=(E=f.data)==null?void 0:E.pages[0].pagination,S=y&&"total"in y&&y.total?y.total:null;return{...f,items:v,totalItems:S,noResults:((M=(I=f.data)==null?void 0:I.pages)==null?void 0:M[0].pagination.data.length)===0,isReloading:f.isFetching&&!f.isFetchingNextPage&&f.isPlaceholderData,sortDescriptor:l,setSortDescriptor:j,searchQuery:m,setSearchQuery:h}}async function Te(e,t,a,r){return t.query&&await new Promise(i=>setTimeout(i,300)),k.get(e,{params:t,signal:t.query?r:void 0}).then(i=>a?a(i.data):i.data)}function Ge(e,t){return Ce({queryKey:["tickets",`${e}`,"replies"],endpoint:`tickets/${e}/replies`,initialPage:t})}function Fe(e,{absolute:t,tab:a}={}){a||(a="tickets");let r=`/agent/users/${e}/${a}`;return t&&(r=`${te().settings.base_url}${r}`),r}function Re(){const{data:e}=se();return o.useCallback(()=>{e&&(e.draft&&q().updateActiveDraft({...e.draft,isDirty:!1}),q().setEditorIsOpen(!0))},[e])}function Ee({clearTicketCache:e=!0}={}){const{ticketId:t}=ae(),{updateActiveDraft:a,discardActiveDraft:r}=K();return P({mutationFn:i=>(a({isSaving:!0}),Ie(i)),onSuccess:async()=>{r(),e&&await D.invalidateQueries({queryKey:["tickets",`${t}`]})},onError:i=>R(i),onSettled:()=>a({isSaving:!1})})}function Ie(e){return k.delete(`replies/${e.id}`).then(t=>t.data)}function Me({draft:e}){const t=Re();return s.jsxs(o.Fragment,{children:[s.jsx(N,{variant:"outline",size:"2xs",className:"ml-14",onClick:()=>t(),children:s.jsx(d,{message:"Edit"})}),s.jsx(Oe,{draft:e})]})}function Oe({draft:e}){return s.jsxs(re,{type:"modal",children:[s.jsx(N,{variant:"outline",size:"2xs",className:"ml-6",children:s.jsx(d,{message:"Discard"})}),s.jsx(Qe,{draft:e})]})}function Qe({draft:e}){const t=Ee(),{close:a}=ie();return s.jsx(ne,{isDanger:!0,title:s.jsx(d,{message:"Discard draft"}),body:s.jsx(d,{message:"Are you sure you want to discard this draft?"}),confirm:s.jsx(d,{message:"Discard"}),onConfirm:()=>t.mutate({id:e.id},{onSuccess:a}),isLoading:t.isPending})}const _e={month:"short",day:"numeric",hour:"numeric",minute:"numeric"};function We({reply:e,isInitial:t,actions:a,attachments:r,className:i}){const n=o.useRef(null);return o.useEffect(()=>{n.current&&ce(n.current)},[]),s.jsxs("div",{className:b("flex items-start gap-20 border-x-2 border-t border-x-transparent py-24",e.type==="drafts"&&"border-l-primary",e.type==="notes"&&"border-l-warning bg-warning/6",i),children:[e.user&&s.jsx(oe,{to:Fe(e.user.id),className:"flex-shrink-0 max-md:hidden",target:"_blank",children:s.jsx(Se,{user:e.user,size:"w-50 h-50",circle:!0})}),s.jsxs("div",{className:"min-w-0 flex-auto",children:[s.jsx(qe,{reply:e,isInitial:t,actions:a}),s.jsx("div",{ref:n,className:"ticket-reply-body mr-24 text-sm",dangerouslySetInnerHTML:{__html:e.body}}),r]})]})}function qe({reply:e,isInitial:t,actions:a}){var i,n;const{user:r}=ue();return s.jsxs("div",{className:"mb-14 flex items-center",children:[s.jsx("div",{className:"font-medium",children:((i=e.user)==null?void 0:i.id)===(r==null?void 0:r.id)?s.jsx(d,{message:"You"}):(n=e.user)==null?void 0:n.display_name}),s.jsx("div",{className:"ml-4",children:s.jsx(Ae,{reply:e,isInitial:t})}),s.jsx("div",{className:"ml-auto mr-4 flex-shrink-0 text-xs text-muted",children:s.jsx(B,{date:e.created_at,options:_e})}),a]})}function Ae({reply:e,isInitial:t}){switch(e.type){case"drafts":return s.jsxs("div",{className:"flex items-center",children:[s.jsx("span",{className:"text-primary",children:s.jsx(d,{message:"created a draft"})}),s.jsx(Me,{draft:e})]});case"notes":return s.jsx("span",{className:"text-warning",children:s.jsx(d,{message:"left a note"})});case"replies":return t?s.jsx("span",{className:"text-muted max-md:hidden",children:s.jsx(d,{message:"started the conversaion"})}):s.jsx("span",{className:"text-muted",children:s.jsx(d,{message:"replied"})})}}function Be(e,t){return P({mutationFn:a=>$e(e,a),onSuccess:async()=>{await D.invalidateQueries({queryKey:["tickets"]})},onError:a=>t?$(a,t):R(a)})}function $e(e,t){return k.put(`tickets/${e}`,t).then(a=>a.data)}const Le={month:"short",day:"numeric"};function Xe({ticket:e,actions:t,children:a}){return s.jsx(o.Fragment,{children:s.jsxs("div",{className:"flex items-start gap-12 px-20 py-14 max-md:flex-col md:items-center",children:[s.jsx(Ke,{ticket:e}),a,s.jsx("div",{className:"mr-24 max-md:hidden"}),s.jsxs("div",{className:"whitespace-nowrap text-muted md:ml-auto",children:[s.jsx(de,{date:e.created_at})," (",s.jsx(B,{date:e.created_at,options:Le}),")"]}),t]})})}function Ke({ticket:e}){const[t,a]=o.useState(!1),[r,i]=o.useState(null),{trans:n}=le(),u=o.useRef(null),c=fe({defaultValues:{subject:e.subject}}),p=Be(e.id,c),m=c.watch("subject"),h=n({message:"Subject"});o.useEffect(()=>{if(u.current){const j=new ResizeObserver(x=>{x[0].contentRect.width>0&&i({width:x[0].contentRect.width,height:x[0].contentRect.height})});return j.observe(u.current),()=>j.disconnect()}},[]);const l=()=>{a(!1),c.getValues("subject")!==e.subject&&p.mutate({subject:c.getValues("subject")},{onSuccess:()=>L(n({message:"Subject updated"}))})};return t?s.jsx(me,{form:c,onSubmit:()=>l(),children:s.jsx(he,{placeholder:h,autoFocus:!0,onBlur:()=>l(),name:"subject",size:"sm",style:{width:r?`${r.width}px`:void 0,height:r?`${r.height}px`:void 0},required:!0})}):s.jsx("h1",{ref:u,tabIndex:0,onClick:()=>a(!0),onFocus:()=>a(!0),className:b("cursor-pointer rounded text-2xl hover:bg-primary/focus",!m&&"text-muted"),children:s.jsx(xe,{label:s.jsx(d,{message:"Edit subject"}),children:s.jsx("span",{children:m||h})})})}function Je({ticket:e,onRemoveTag:t,tagType:a,size:r="xs",...i}){var n,u;return(n=e.tags)!=null&&n.length?s.jsx(ve,{...i,size:r,selectable:!!t,children:(u=e.tags)==null?void 0:u.filter(c=>c.type!=="status"&&(!a||c.type===a)).map(c=>s.jsx(ge,{onRemove:t?()=>t(c):void 0,children:c.display_name},c.id))}):null}function et({isLoading:e,onSubmit:t}){return s.jsx(N,{variant:"flat",color:"primary",radius:"rounded-none",disabled:e,onClick:()=>t==null?void 0:t(),children:s.jsx(d,{message:"Send reply"})})}function tt(e){return P({mutationFn:t=>ze(t),onSuccess:async()=>{await D.invalidateQueries({queryKey:["tickets"]}),L(pe("Ticket created"))},onError:t=>$(t,e)})}function ze(e){return k.post("tickets",e).then(t=>t.data)}export{Ze as I,et as S,We as T,Se as U,Ue as a,K as b,Ge as c,Re as d,Xe as e,Je as f,Ce as g,Be as h,Fe as i,Ee as j,_ as k,tt as l,Le as m,q as t,Ye as u};
//# sourceMappingURL=use-create-ticket-5b9f3565.js.map
